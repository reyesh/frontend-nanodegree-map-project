<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>P5-1: Neighborhood Map Project</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <style>
body{background-color:#eee}#map{width:100%;height:650px}#content{position:absolute;top:20px;left:10px;width:300px}.nav{width:100%}.badge{background-color:#5bc0de}.activepost{background-color:#5bc0de!important;border-border:#46b8da!important}.post-content,.search-content{padding-left:23px;padding-right:23px}.post-container li:hover{background-color:#777}.post-container li:active{background-color:#6f5499}.post-container p{display:inline}.post-container button{position:absolute;right:40px}.post_body{border:1px solid #d8d8d8;margin-bottom:10px;border-top:0 solid #000;padding:10px 20px}.input-group,.post{padding-bottom:10px;background-color:#fff;width:100%}.post{padding-top:10px}.posts{clear:both;list-style:none;padding-left:0;margin-right:auto;margin-left:auto}.posts li{padding-left:20px;padding-right:20px;margin-bottom:1px;word-wrap:break-word}.input-group{padding-top:20px;border-left:1px solid #ddd;border-right:1px solid #ddd}@media screen and (max-width:500px){#map{height:250px}}@media screen and (min-width:501px) and (max-width:991px){#map{height:350px}}    </style>
  </head>
  <body>
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div class="header well">
                    <h1>Map Notes <span class="badge" data-bind="text: numOfNotes"></span></h1>
                    <p>Post any note in your local area anonymously. <em>You need to share location to make this work</em></p>
                </div>
            </div>
        </div>
        <div class="row">

            <div class="col-md-9 col-md-push-3">
                <div class="tabs">

                    <ul class="nav nav-tabs" data-bind="foreach: tabs">
                      <li role="presentation" data-bind="css: { active: $data == $root.chosenTabId() }"><a href="#" data-bind="text: $data, click: $root.goToTab">Search</a></li>
                    </ul>

                    <div class="input-group search-content" data-bind="visible: ShowWhichTab('Search')">
                      <input type="search" class="form-control" placeholder="Search for..." data-bind="value: query, valueUpdate: 'keyup'" autocomplete="off">
                      <span class="input-group-btn">
                        <button class="btn btn-default" type="button">Search</button>
                      </span>
                    </div>

                    <div class="input-group post-content" data-bind="visible: ShowWhichTab('Post')">
                      <input type="text" class="form-control" placeholder="What's on your mind?..." data-bind='value: noteToPush, valueUpdate: "afterkeydown"'>
                      <span class="input-group-btn">
                        <button class="btn btn-default" type="button" data-bind="click: pushNote">Post</button>
                      </span>
                    </div>

                    <div class="input-group post-content" data-bind="visible: ShowWhichTab('About')">
                        <p>This webapp uses Google API, Firebase API, Bootstrap, KnockoutJS and hosted on Github. <a href="https://github.com/reyesh/frontend-nanodegree-map-project">Github Repository.</a></p>
                    </div>

                </div>
                <div id="map">
                </div>
            </div>

            <div class="col-md-3 col-md-pull-9">
                <div class="post-container">
                    <ul class="posts" data-bind="foreach: notes">
                      <li class="post" data-bind="css: { activepost: $data.selected }, click: $parent.infoWinClick.bind($data,$index)">
                        <p data-bind="text: $data.title"></p>
                        <button type="button" class="btn btn-danger btn-xs" aria-label="Left Align" data-bind="click: $parent.deletePost">
                            <span class="glyphicon glyphicon glyphicon-remove" aria-hidden="true"></span>
                        </button>
                      </li>
                    </ul>  
                </div> 
            </div>

        </div>
    </div>

    <script src='https://cdn.firebase.com/js/client/2.2.1/firebase.js'></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/knockout/3.3.0/knockout-min.js"></script>
    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script> 
    <script src="//maps.googleapis.com/maps/api/js?key=AIzaSyAoSdqFIjWVu4usSM6hDOYxZYjMHnP3JCQ">
    </script>
    <script>
function ViewModel(){var a=this;a.notes=ko.observableArray([]),a.numOfNotes=ko.observable(0),a.searchNotes=ko.observableArray([]),a.query=ko.observable(""),a.noteToPush=ko.observable(""),a.currentNote=ko.observable(""),a.tabs=["Search","Post","About"],a.chosenTabId=ko.observable("Search");var b=new google.maps.InfoWindow,c=new Firebase("https://map-notes.firebaseio.com/");a.ShowWhichTab=function(b){return b==a.chosenTabId()?ko.observable(!0):ko.observable(!1)},a.goToTab=function(b){a.chosenTabId(b)},a.clickedNote=function(a){console.log(a)},a.deletePost=function(a){console.log("delete: "+a.title),console.log("delete: "+a.fbkey),c.child(a.fbkey).remove()},a.pushNote=function(){var a=new Date,b=a.getTime();c.push({note:this.noteToPush(),pos:pos,time:b}),this.noteToPush("")},c.on("child_added",function(c){({note:c.val().note,pos:c.val().pos,key:c.key()});a.notes.push(new google.maps.Marker({position:c.val().pos,map:map,title:c.val().note,selected:ko.observable(!1),animation:google.maps.Animation.DROP,fbkey:c.key()}));var d=a.notes.pop();d.addListener("click",function(){b.setContent("<h1>"+d.title+"</h1>"),a.resetSelect(),d.selected(!0),b.open(map,d),d.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){d.setAnimation(null)},750)}),a.notes.push(d),c.ref().on("value",function(b){b.val()?(console.log(b.val().pos),d.title=b.val().note,d.selected(!1)):(d.setMap(null),a.notes.remove(d))}),a.numOfNotes(a.notes().length),a.searchNotes(a.notes().slice(0))}),a.resetSelect=function(){for(var b=0;b<a.notes().length;b++)a.notes()[b].selected(!1)},a.infoWinClick=function(c,d){console.log("infowin: "+d.title),a.currentNote(a.notes()[c()]),a.resetSelect(),d.selected(!0),b.setContent("<h1>"+d.title+"</h1>"),b.open(map,d),d.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){d.setAnimation(null)},750)},a.deleteObArray=function(a){console.log(a().length);for(var b=0;b<a().length;b++)a()[b].setMap(null),a()[b].selected(!1);return a},a.search=function(b){a.notes=a.deleteObArray(a.notes),a.notes.removeAll();var c;ko.utils.arrayForEach(a.searchNotes(),function(d){d.title.toLowerCase().indexOf(b.toLowerCase())>=0&&(a.notes.push(d),c=a.notes.pop(),c.setMap(map),a.notes.push(c))})},a.query.subscribe(a.search)}function initMap(){function a(a,b,c){b.setPosition(c),b.setContent(a?"Error: The Geolocation service failed.":"Error: Your browser doesn't support geolocation.")}var b=new google.maps.Map(document.getElementById("map"),{center:{lat:87.389,lng:-72.094},scrollwheel:!1,zoom:12});return navigator.geolocation?navigator.geolocation.getCurrentPosition(function(a){pos={lat:a.coords.latitude,lng:a.coords.longitude},b.setCenter(pos)},function(){a(!0,infoWindow,b.getCenter())}):a(!1,infoWindow,b.getCenter()),b}var map,pos={};$(function(){ko.applyBindings(new ViewModel),map=initMap()});    </script>
  </body>
</html>
