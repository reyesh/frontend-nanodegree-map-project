<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>P5-1: Neighborhood Map Project</title>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

    <script   src="https://code.jquery.com/jquery-1.12.3.min.js"   integrity="sha256-aaODHAgvwQW1bFOGXMeX+pC4PZIPsvn2h1sArYOhgXQ="   crossorigin="anonymous"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
    <style>
body{background-color:#eee}#content{position:absolute;top:20px;left:10px;width:300px}.nav{width:100%}.badge{background-color:#5bc0de}.activepost{background-color:#5bc0de!important;border-border:#46b8da!important}.search-content{padding-left:23px;padding-right:23px}.post-content{width:400px}#map,.page-wrap,.post{width:100%}.post-container li:hover{background-color:#777}.post-container li:active{background-color:#6f5499}.post-container p{display:inline}.post-container button{position:absolute;right:10px}.post_body{border:1px solid #d8d8d8;margin-bottom:10px;border-top:0 solid #000;padding:10px 20px}.post{padding-top:10px;padding-bottom:10px;background-color:#fff}.posts{clear:both;list-style:none;padding-left:0;margin-right:auto;margin-left:auto}.posts li{padding-left:20px;padding-right:20px;margin-bottom:1px;word-wrap:break-word}.input-group{padding:0}@media screen and (max-width:500px){.post-container{overflow:scroll;position:relative}}@media screen and (min-width:501px) and (max-width:991px){.post-container{height:772px;overflow:scroll;position:relative}}@media screen and (min-width:992px){.header{height:125px}.post-container{height:772px;overflow:scroll;position:relative}}#map{height:100%;position:absolute}.page-wrap{float:right;transition:width .3s ease}.main-header{padding:5px 0 5px 65px;color:#000;position:fixed;width:100%;left:0;transition:all .3s ease;z-index:9}.main-header a{position:absolute;left:20px;top:20px;color:#000;font-size:32px}.main-nav{position:fixed;top:0;width:0;height:100%;background:#222;overflow-y:auto;transition:width .3s ease;white-space:nowrap;text-transform:uppercase}.note{padding:34px;border-bottom:1px solid #666}.note button{position:absolute;right:20px}.main-nav a{color:#fff}.main-nav a:focus,.main-nav a:hover{background:#333}.main-nav:after{content:"";position:absolute;top:0;right:0;height:100%;width:4px;background:linear-gradient(to right,rgba(0,0,0,0),rgba(0,0,0,.4))}.close-menu{display:none}#main-nav:target{width:30%}#main-nav:target+.page-wrap{width:70%}#main-nav:target+.page-wrap .close-menu{display:block}#main-nav:target+.page-wrap .main-header{width:70%;left:30%}    </style>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-67703197-3', 'auto');
      ga('send', 'pageview');
    </script>
  </head>
  <body>

    <nav class="main-nav" id="main-nav">

      <div class="input-group search-content">
        <input type="search" class="form-control" placeholder="Search for..." data-bind="value: query, valueUpdate: 'keyup'" autocomplete="off">
        <span class="input-group-btn">
          <button class="btn btn-default" type="button"><span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
        </span>
      </div>

      <div data-bind="foreach: notes">
        <div class="note">
          <a href="#" data-bind="text: $data.title, css: { activepost: $data.selected }, click: $parent.infoWinClick.bind($data,$index)"></a>
          <button type="button" class="btn btn-danger btn-xs" aria-label="Left Align" data-bind="click: $parent.deletePost">
            <span class="glyphicon glyphicon glyphicon-remove" aria-hidden="true"></span>
          </button>
        </div>
      </div>

    </nav>

    <div class="page-wrap">
      <header class="main-header">
        <a href="#main-nav">&#9776;</a>
        <a href="#" class="close-menu">&#9776;</a>
        <h1>Map Notes <span class="badge" data-bind="text: numOfNotes"></span></h1>
        <p>Post any note in your local area anonymously. <em>You need to share location to make this work</em></p>
        <div class="post-content input-group">
          <input type="text" class="form-control" placeholder="What's on your mind?..." data-bind='value: noteToPush, valueUpdate: "afterkeydown"'>
          <span class="input-group-btn">
            <button class="btn btn-default" type="button" data-bind="click: pushNote">
              <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>
            </button>
          </span>
        </div>
      </header>

      <div id="map">
      </div>
    </div>
    <div id="modals">
    </div>
    <script src='https://cdn.firebase.com/js/client/2.2.1/firebase.js'></script>
    <script type="text/javascript">
        // error modal
         var HTMLloadingModal = '<div class="modal fade bs-example-modal-sm" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"><div class="modal-dialog modal-sm" role="document"><div class="modal-content"><div class="modal-header"><h4 class="modal-title" id="myModalLabel">Error</h4></div><div class="modal-body text-center"><p>Github pages does not support https for geolocation to work. The site has been moved to google app engine @ <a href="https://map-notes-1307.appspot.com/">https://map-notes-1307.appspot.com/</a></p></div></div></div></div>';
 
         function initError() {
 
             $("#modals").append(HTMLloadingModal);
             $('#myModal').modal({
                  backdrop: 'static',
                  keyboard: false
                });
         }

        $(document).ready(initError());

        //Function that initializing the google map
        var map;
        var infoWindow;
        var pos = {};

        function initMap(){

            map = new google.maps.Map(document.getElementById('map'), {
                              center: {lat: 87.389, lng: -72.094},
                              scrollwheel: false,
                              zoom: 12
                              });
          
            infoWindow = new google.maps.InfoWindow();
            //infoWindow.setContent( "asdf" );   


          // Try HTML5 geolocation.
          if (navigator.geolocation){
            navigator.geolocation.getCurrentPosition(function(position) {
              pos = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
              };

            map.setCenter(pos);

            }, function() {
              handleLocationError(true, map.getCenter());
            });
          } else {
            // Browser doesn't support Geolocation
            handleLocationError(false, map.getCenter());
          }

          function handleLocationError(browserHasGeolocation, pos){
          /*infoWindow.setPosition(pos);
          infoWindow.setContent(browserHasGeolocation ?
                                'Error: The Geolocation service failed.' :
                                'Error: Your browser doesn\'t support geolocation.');*/
          console.log("Error: Geolocation failed: " + browserHasGeolocation + ": " + pos);

          }

            // applying ko binding after load
            ko.applyBindings( new ViewModel() );
        }

        function googleError (){
            console.log("error loading google maps api");
            initError();
        }

    </script>
    <script async defer src="//maps.googleapis.com/maps/api/js?key=AIzaSyBlWRZBHRJmXN2GqzK8TyO8U0_Y53nHIJ4&callback=initMap" onerror="googleError()">
    </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/knockout/3.3.0/knockout-min.js"></script>   
    <script>
function ViewModel(){var a=this;a.notes=ko.observableArray([]),a.numOfNotes=ko.observable(0),a.searchNotes=ko.observableArray([]),a.query=ko.observable(""),a.noteToPush=ko.observable(""),a.currentNote=ko.observable(""),a.tabs=["Search","Post","About"],a.chosenTabId=ko.observable("Search");var b=new Firebase("https://map-notes.firebaseio.com/");a.ShowWhichTab=function(b){return ko.observable(b==a.chosenTabId())},a.goToTab=function(b){a.chosenTabId(b)},a.deletePost=function(a){console.log("delete: "+a.title),console.log("delete: "+a.fbkey),b.child(a.fbkey).remove()},a.pushNote=function(){var a=new Date,c=a.getTime();b.push({note:this.noteToPush(),pos:pos,time:c}),this.noteToPush("")},b.on("child_added",function(b){({note:b.val().note,pos:b.val().pos,key:b.key()});a.notes.push(new google.maps.Marker({position:b.val().pos,map:map,title:b.val().note,selected:ko.observable(!1),animation:google.maps.Animation.DROP,fbkey:b.key()}));var c=a.notes.pop();c.addListener("click",function(){infoWindow.setContent("<h1>"+c.title+"</h1>"),a.resetSelect(),c.selected(!0),infoWindow.open(map,c),c.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){c.setAnimation(null)},700)}),a.notes.push(c),b.ref().on("value",function(b){b.val()?(console.log(b.val().pos),c.title=b.val().note,c.selected(!1)):(c.setMap(null),a.notes.remove(c))}),a.numOfNotes(a.notes().length),a.searchNotes(a.notes().slice(0))}),a.resetSelect=function(){for(var b=0;b<a.notes().length;b++)a.notes()[b].selected(!1)},a.infoWinClick=function(b,c){console.log("infowin: "+c.title),a.currentNote(a.notes()[b()]),a.resetSelect(),c.selected(!0),infoWindow.setContent("<h1>"+c.title+"</h1>"),infoWindow.open(map,c),c.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){c.setAnimation(null)},750)},a.deleteObArray=function(a){console.log(a().length);for(var b=0;b<a().length;b++)a()[b].setMap(null),a()[b].selected(!1);return a},a.search=function(b){a.notes=a.deleteObArray(a.notes),a.notes.removeAll();var c;ko.utils.arrayForEach(a.searchNotes(),function(d){d.title.toLowerCase().indexOf(b.toLowerCase())>=0&&(a.notes.push(d),c=a.notes.pop(),c.setMap(map),a.notes.push(c))})},a.query.subscribe(a.search)}$(function(){});    </script>
  </body>
</html>
